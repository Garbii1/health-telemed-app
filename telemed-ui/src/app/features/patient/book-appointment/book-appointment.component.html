<!-- src/app/features/patient/book-appointment/book-appointment.component.html -->
<div class="container pt-4 mt-4"> <!-- Added padding -->
  <h2 class="mb-1">Book a Virtual Consultation</h2>
  <p class="text-muted mb-4 border-bottom pb-3">Select a doctor and choose a suitable time for your appointment.</p>

  <div class="card shadow-sm">
    <div class="card-body p-4 p-md-5">
      <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()">

        <!-- Show spinner while loading doctors -->
        <div *ngIf="isLoadingDoctors" class="text-center mb-3 py-5">
           <app-loading-spinner [isLoading]="true" message="Loading doctors..."></app-loading-spinner>
        </div>

        <!-- Show form fields *only* when NOT loading doctors -->
        <ng-container *ngIf="!isLoadingDoctors">
             <div *ngIf="errorMessage && !isSubmitting" class="alert alert-danger"> {{ errorMessage }} <button type="button" class="btn btn-sm btn-outline-secondary ms-3" (click)="loadDoctors()">Retry</button> </div>
             <div *ngIf="successMessage" class="alert alert-success"> {{ successMessage }} Redirecting... </div>

            <!-- Doctor Selection (Now loops over 'doctors' property) -->
            <div class="form-group mb-3">
              <label for="doctor_id" class="form-label">Select Doctor <span class="text-danger">*</span></label>
              <!-- Bind to the component's doctors array -->
              <select id="doctor_id" class="form-select form-select-lg" formControlName="doctor_id" [class.is-invalid]="doctor_id?.invalid && doctor_id?.touched">
                <option value="" disabled>-- Choose a Doctor --</option>
                <!-- Loop over the component property 'doctors' -->
                <option *ngFor="let doctor of doctors" [value]="doctor.id">
                   Dr. {{ doctor.first_name }} {{ doctor.last_name }}
                   <!-- Safely access nested specialization -->
                   <span *ngIf="doctor.profile?.doctor_details?.specialization"> ({{ doctor.profile.doctor_details.specialization }})</span>
                   <span *ngIf="!doctor.profile?.doctor_details?.specialization"> (General)</span>
                </option>
                 <!-- Show message if array is empty AFTER loading -->
                 <option *ngIf="!doctors || doctors.length === 0" value="" disabled>No doctors available</option>
              </select>
               <div *ngIf="doctor_id?.invalid && doctor_id?.touched" class="invalid-feedback"> Please select a doctor. </div>
            </div>

            <!-- Date and Time Selection -->
            <div class="form-group mb-3"> <label for="appointment_time" class="form-label">Select Date and Time <span class="text-danger">*</span></label> <input type="datetime-local" id="appointment_time" class="form-control form-control-lg" formControlName="appointment_time" [min]="minDateTime" [class.is-invalid]="appointment_time?.invalid && appointment_time?.touched"> <div *ngIf="appointment_time?.invalid && appointment_time?.touched" class="invalid-feedback text-start mt-1 ps-1"> <div *ngIf="appointment_time?.errors?.['required']">Please select date/time.</div> <div *ngIf="appointment_time?.errors?.['pastDate']">Cannot book in past.</div> </div> <small class="form-text text-muted">Select a date and time in the future.</small> </div>

            <!-- Reason for Appointment -->
            <div class="form-group mb-3"> <label for="reason" class="form-label">Reason for Appointment (Optional)</label> <textarea id="reason" class="form-control" rows="4" formControlName="reason" placeholder="Briefly describe the reason..." [class.is-invalid]="reason?.invalid && reason?.touched"></textarea> <div *ngIf="reason?.invalid && reason?.touched" class="invalid-feedback text-start mt-1 ps-1"> <div *ngIf="reason?.errors?.['maxlength']">Reason too long (max 500 chars).</div> </div> </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3" [disabled]="isSubmitting || appointmentForm.invalid || isLoadingDoctors"> <!-- Disable while loading doctors too -->
              <span *ngIf="!isSubmitting"><i class="fas fa-check me-1"></i> Book Appointment</span>
              <span *ngIf="isSubmitting"> <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Booking... </span>
            </button>
        </ng-container> <!-- End *ngIf="!isLoadingDoctors" -->

      </form>
    </div>
  </div>
</div>