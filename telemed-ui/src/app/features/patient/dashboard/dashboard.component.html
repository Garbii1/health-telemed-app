<!-- src/app/features/patient/dashboard/dashboard.component.html -->
<div class="container pt-4 mt-4"> <!-- Added pt-4 for extra padding from header -->
  <h2>Patient Dashboard</h2>
  <p *ngIf="currentUser">Welcome, {{ currentUser.username }}!</p>
  <hr>

  <!-- ===== Loading State ===== -->
  <div *ngIf="isLoading" class="text-center mt-5 pt-5">
    <app-loading-spinner [isLoading]="true" message="Loading dashboard data..."></app-loading-spinner>
  </div>

  <!-- ===== Error State ===== -->
  <div *ngIf="errorMessage && !isLoading" class="alert alert-warning mt-3">
     {{ errorMessage }}
     <button class="btn btn-sm btn-outline-secondary ms-3" (click)="loadDashboardData()">Retry</button>
   </div>

  <!-- ===== Data Display State ===== -->
  <!-- Bind directly to the component property 'dashboardData' -->
  <!-- Show content only when NOT loading AND NO error AND data exists -->
  <div *ngIf="!isLoading && !errorMessage && dashboardData">
    <ng-container> <!-- Removed the outer ngIf="data" as we check dashboardData directly -->

        <!-- Quick Links/Actions Section -->
        <div class="row mb-4 quick-actions">
           <!-- ... Action cards ... -->
           <div class="col-md-4 mb-3"> <div class="card action-card h-100 shadow-sm"> <div class="card-body text-center d-flex flex-column justify-content-center align-items-center"> <i class="fas fa-calendar-plus fa-2x text-primary mb-3"></i> <h5 class="card-title">Book Appointment</h5> <p class="card-text text-muted mb-3"><small>Schedule your next consultation.</small></p> <a routerLink="../book-appointment" class="btn btn-primary stretched-link mt-auto">Book Now</a> </div> </div> </div>
           <div class="col-md-4 mb-3"> <div class="card action-card h-100 shadow-sm"> <div class="card-body text-center d-flex flex-column justify-content-center align-items-center"> <i class="fas fa-heartbeat fa-2x text-danger mb-3"></i> <h5 class="card-title">Add Vitals</h5> <p class="card-text text-muted mb-3"><small>Record your latest measurements.</small></p> <a routerLink="../vitals" class="btn btn-danger stretched-link mt-auto">Add Vital Record</a> </div> </div> </div>
           <div class="col-md-4 mb-3"> <div class="card action-card h-100 shadow-sm"> <div class="card-body text-center d-flex flex-column justify-content-center align-items-center"> <i class="fas fa-user-edit fa-2x text-success mb-3"></i> <h5 class="card-title">My Profile</h5> <p class="card-text text-muted mb-3"><small>View or update your information.</small></p> <a routerLink="../profile" class="btn btn-success stretched-link mt-auto">View Profile</a> </div> </div> </div>
        </div>

        <div class="row">
            <!-- Upcoming Appointments List -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center"> <span><i class="fas fa-calendar-check me-2 text-primary"></i>Upcoming Appointments</span> <a routerLink="../appointments" class="btn btn-sm btn-outline-secondary">View All</a> </div>
                    <div class="card-body">
                        <!-- Check dashboardData.upcomingAppointments -->
                        <div *ngIf="dashboardData.upcomingAppointments && dashboardData.upcomingAppointments.length > 0; else noAppointments">
                            <div class="list-group list-group-flush"> <a *ngFor="let appt of dashboardData.upcomingAppointments" routerLink="../appointments" class="list-group-item list-group-item-action px-0"> <div class="d-flex w-100 justify-content-between"> <h6 class="mb-1 text-primary">Dr. {{ appt.doctor_name || 'N/A' }}</h6> <small class="text-success">{{ formatDate(appt.appointment_time) }}</small> </div> <small class="text-muted d-block">{{ appt.reason || 'No reason specified' }}</small> </a> </div>
                        </div>
                         <ng-template #noAppointments> <div class="text-center text-muted py-4"> <i class="fas fa-calendar-times fa-2x mb-2"></i> <p>No upcoming appointments scheduled.</p> </div> </ng-template>
                    </div>
                </div>
            </div>

            <!-- Recent Vitals Summary -->
            <div class="col-lg-6 mb-4">
               <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center"> <span><i class="fas fa-notes-medical me-2 text-danger"></i>Recent Vitals</span> <a routerLink="../vitals" class="btn btn-sm btn-outline-secondary">View History</a> </div>
                    <div class="card-body">
                        <!-- Check dashboardData.recentVitals -->
                        <div *ngIf="dashboardData.recentVitals && dashboardData.recentVitals.length > 0; else noVitals">
                            <div class="list-group list-group-flush"> <a *ngFor="let vital of dashboardData.recentVitals" routerLink="../vitals" class="list-group-item list-group-item-action px-0"> <div class="d-flex w-100 justify-content-between align-items-center flex-wrap"> <div class="vitals-summary mb-1 mb-md-0"> <!-- Vitals details --> </div> <small class="text-info flex-shrink-0 ms-md-2">{{ formatDate(vital.record_time) }}</small> </div> <small *ngIf="vital.notes" class="text-muted d-block mt-1"><em>Notes: {{ vital.notes | slice:0:70 }}{{ vital.notes.length > 70 ? '...' : ''}}</em></small> </a> </div>
                        </div>
                        <ng-template #noVitals> <div class="text-center text-muted py-4"> <i class="fas fa-file-medical-alt fa-2x mb-2"></i> <p>No recent vital records found.</p> </div> </ng-template>
                    </div>
               </div>
            </div>
        </div>

    </ng-container> <!-- Removed the outer ngIf="data" check -->

     <!-- Template shown if data is null after loading (due to error) AND not loading -->
     <ng-template #noDataFound>
         <div *ngIf="!errorMessage" class="alert alert-info mt-3"> No dashboard data available at the moment. </div>
     </ng-template>

  </div> <!-- End main *ngIf="!isLoading && dashboardData" -->

</div>

<!-- Component-specific styles -->
<style>
  :host { display: block; padding-top: 1rem; /* Add padding specific to this component host */ }
  .quick-actions .action-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; border: 1px solid var(--border-color); cursor: pointer; }
  .quick-actions .action-card:hover { transform: translateY(-5px); box-shadow: var(--box-shadow-hover); }
  .quick-actions .action-card .card-body { z-index: 2; position: relative; }
  .quick-actions .action-card .stretched-link::after { position: absolute; top: 0; right: 0; bottom: 0; left: 0; z-index: 1; content: ""; }
  .card-header span { font-weight: 600; color: var(--primary-color); }
  .list-group-flush .list-group-item { border-width: 0 0 1px; }
  .list-group-flush .list-group-item:last-child { border-bottom-width: 0; }
  .vitals-summary span { white-space: nowrap; margin-right: 1rem !important; } /* Added spacing */
  .vitals-summary .fas { width: 1.2em; }
  @media (max-width: 767px) { .vitals-summary span { margin-right: 0.5rem !important; } } /* Adjust spacing on mobile */
</style>